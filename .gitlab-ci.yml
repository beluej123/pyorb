# Official language image. Look for the different tagged releases at:
# https://hub.docker.com/r/library/python/tags/
image: python:3.8.10

stages:
  - test
  - release
  - deploy

variables:
  #Change pip's cache directory to be inside 
  # the project directory since we can
  # only cache local items.
  PIP_CACHE_DIR: "${CI_PROJECT_DIR}/.cache/pip"
  #Use a gitlab variable to securly store the 
  # user token used to upload to PyPI
  PYPI_TOKEN: $PYPI_TOKEN



#Pip's cache doesn't store the python packages
# https://pip.pypa.io/en/stable/reference/pip_install/#caching
# If you want to also cache the installed packages, you have to install
# them in a virtualenv and cache it as well.
cache:
  key: "${CI_JOB_NAME}"
  paths:
    - .cache/pip
    - .venv


#Template script for all jobs that installs
# the package and dependancies into a virtualenv
.install-deps-template: &install-deps
  # Print version for debug
  - python -V
  # Prepare and activate virtualenv
  - pip install virtualenv
  - pip install -U pip
  - virtualenv venv
  - source venv/bin/activate
  # install the develop dependancies
  - pip install .[develop]
  - apt update
  - apt install -y pandoc


default:
  tags:
    - IRF
  before_script:
    - *install-deps # execute script in alias


#Template for testing on python images, 
# extend this for each python-platform 
# the package is intended to work on
# Template information: 
#   https://docs.gitlab.com/ee/ci/yaml/yaml_specific_features.html
.py-test-template: &python-test
  stage: test
  allow_failure: true
  script: 
    - pytest
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# Run all diagnostics
diagnostics:
  stage: test
  script: 
    - coverage run -m pytest > pytest_report
    - coverage report -m > coverage_report
    - python -m flake8 --extend-exclude venv pyorb > flake8_report
    - radon cc -a pyorb/ > radon_cc_report
    - radon raw -s pyorb/ > radon_raw_report
    - radon mi -s pyorb/ > radon_mi_report
    - radon hal pyorb/ > radon_hal_report
  allow_failure: true
  artifacts:
    paths:
      - "*_report"
  only:
    - tags

##########################
## Platforms to test on ##

# python3.7:
#   <<: *python-test # Merge the contents of the alias
#   image: python:3.7

# python3.9:
#   <<: *python-test # Merge the contents of the alias
#   image: python:3.9

python3.8:
  <<: *python-test

#Build and check integrity of distribution
package:
  stage: release
  script:
    - python -m build
    - python -m twine check dist/*
  artifacts:
    paths:
      - dist/*
  only:
    - tags

#Compile documentation for publication
pages:
  stage: deploy
  script:
    - cd docs
    - make html
    - mv build ../public
  artifacts:
    paths:
      - public
  only:
    - tags

#Publish package on public PyPI if
# the commit has a version tag and is on main
pypi:
  stage: deploy
  script:
    - >
      TWINE_USERNAME=__token__
      TWINE_PASSWORD=$PYPI_TOKEN
      python -m twine upload dist/*
  only:
    - tags